{% extends ':site:base.html.twig' %}
{% block title %}Productos{% endblock %}
{% block css %}
    <link href="{{ asset('bundles/conceptos/products/css/price-range.css') }}" type="text/css" rel="stylesheet">
    <link href="{{ asset('bundles/conceptos/libs/select2/css/select2.min.css') }}" rel="stylesheet">
    <link href="{{ asset('bundles/conceptos/libs/select2/css/select2-bootstrap.min.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('bundles/conceptos/home/css/component.css') }}">
    <link href="{{ asset('bundles/conceptos/products/css/products.css') }}" type="text/css" rel="stylesheet">
{% endblock %}
{% block body %}
  <form action="{{ path('products') }}" method="get">
    <input type="hidden" value="{{ app.request.query.get('term') }}" id="term">
    <input type="hidden" value="{{ app.request.query.get('inOffer') }}" id="inOffer">
    <input type="hidden" value="{{ app.request.query.get('recent') }}" id="recent">
    <input type="hidden" value="{{ app.request.query.get('inStore') }}" id="inStore">
    <input type="hidden" value="{{ app.request.query.get('categories') }}" id="categories" name="categories">
    <input type="hidden" value="{{ app.request.query.get('color') }}" id="color">
    <input type="hidden" value="{{ app.request.query.get('material') }}" id="material">

    <div id="giftCardsModal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">{{membership.data.giftCardSection.modalText}}</h4>
          </div>
          <div class="modal-body">
            <div class="d-flex flex-wrap">
              <div class="col-6 pl-0">
                <div class="d-flex justify-content-center">
                  <a class="conceptos-add-gift-card-to-cart-button" data-path="{{path('add_shop_card', {id: "target15"})}}">
                    <img class="gift-card-img d-none d-lg-block" src="{{membership.data.giftCardSection.giftCard15Image.path}}">
                    <img class="gift-card-img-short d-lg-none pr-1" src="{{membership.data.giftCardSection.giftCard15Image.path}}">
                  </a>
                </div>
              </div>
              <div class="col-6 pl-0">
                <div class="d-flex justify-content-center">
                  <a class="conceptos-add-gift-card-to-cart-button" data-path="{{path('add_shop_card', {id: "target25"})}}">
                    <img class="gift-card-img d-none d-lg-block" src="{{membership.data.giftCardSection.giftCard25Image.path}}">
                    <img class="gift-card-img-short d-lg-none pl-1" src="{{membership.data.giftCardSection.giftCard25Image.path}}">
                  </a>
                </div>
              </div>
              <div class="col-6 pt-3 pl-0">
                <div class="d-flex justify-content-center">
                  <a class="conceptos-add-gift-card-to-cart-button" data-path="{{path('add_shop_card', {id: "target50"})}}">
                    <img class="gift-card-img d-none d-lg-block" src="{{membership.data.giftCardSection.giftCard50Image.path}}">
                    <img class="gift-card-img-short d-lg-none  pr-1" src="{{membership.data.giftCardSection.giftCard50Image.path}}">
                  </a>
                </div>
              </div>
              <div class="col-6 pt-3 pl-0">
                <div class="d-flex justify-content-center">
                  <a class="conceptos-add-gift-card-to-cart-button" data-path="{{path('add_shop_card', {id: "target100"})}}">
                    <img class="gift-card-img d-none d-lg-block" src="{{membership.data.giftCardSection.giftCard100Image.path}}">
                    <img class="gift-card-img-short d-lg-none pl-1" src="{{membership.data.giftCardSection.giftCard100Image.path}}">
                  </a>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn navigation-button" data-dismiss="modal">Aceptar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="filterProductsModal" class="modal fade">
      <div class="modal-dialog modal-lg mt-0">
        <div class="modal-content">
          <div class="modal-body">
            <div class="d-flex flex-column p-2">
              <span class="conceptos-title-strong mb-2">FILTROS</span>
              <div class="d-flex flex-column conceptos-white-background p-2">
                <span class="conceptos-title-strong">PRECIO</span>
                <div class="d-flex justify-content-between">
                  <div class="d-flex align-items-center">
                    <label class="conceptos-subtitle m-0 mr-2" for="priceMin">MIN</label>
                    <input type="number" min="0" name="priceMin"
                           {% if app.request.query.get('priceMin') is not null %}value="{{ app.request.query.get('priceMin') }}"{% endif %}>
                  </div>
                  <div class="d-flex align-items-center">
                    <label class="conceptos-subtitle m-0 mr-2" for="priceMax">MAX</label>
                    <input type="number" min="0" name="priceMax"
                           {% if app.request.query.get('priceMax') is not null %}value="{{ app.request.query.get('priceMax') }}" {% endif %}>
                  </div>
                </div>
                <div class="d-flex flex-column mt-2">
                  <label class="conceptos-title-strong m-0 mr-2" for="color">COLOR</label>
                  <select name="color">
                    <option value="-1">Todos</option>
                    {% for color in colors %}
                      {% set selectedColor = app.request.query.get('color', -1) %}
                      <option value="{{color.id}}"
                              {% if selectedColor != -1 and selectedColor == color.id %}selected{% endif %}>
                        {{color.name}}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="d-flex flex-column mt-2">
                  <label class="conceptos-title-strong m-0 mr-2" for="material">MATERIAL</label>
                  <select name="material">
                    <option value="-1">Todos</option>
                    {% for material in materials %}
                      {% set selectedMaterial = app.request.query.get('material', -1) %}
                      <option value="{{material.id}}"
                              {% if selectedMaterial != -1 and selectedMaterial == material.id %}selected{% endif %}>
                        {{material.name}}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <button id="filter-products-button" class="conceptos-primary-button mt-2" type="submit">
                <span>BUSCAR</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if inOfferHeader %}
      {% set image = page.data.inOfferImage.path %}
    {% elseif inStoreHeader %}
      {% set image = page.data.inStoreImage.path %}
    {% elseif recentHeader %}
      {% set image = page.data.newImage.path %}
    {% elseif generalHeader %}
      {% set image = page.data.generalImage.path %}
    {% else %}
      {% set image = vich_uploader_asset(mainCategory, 'imageSiteFile') %}
    {% endif%}
    <div>
      <img class="conceptos-image conceptos-header-image" src="{{ image }}">
    </div>

    <div class="d-flex flex-column">
      <div class="d-flex align-self-end conceptos-gift-card-section p-1 mr-2" data-toggle="modal" data-target="#giftCardsModal">
        <div class="d-flex align-items-center">
          <span class="conceptos-title pt-1 pb-1 ml-2">TARJETAS DE REGALO</span>
          <img class="conceptos-icon ml-2 mr-2" src="{{ asset('bundles/conceptos/images/home/forward.png') }}">
        </div>
      </div>
      <div class="d-flex justify-content-between align-items-center ml-2 mr-2 mt-3 mb-3">
        <div class="d-flex flex-column ml-lg-5">
          {% if mainCategory %}
            <span class="conceptos-title"><span class="conceptos-title-strong">PRODUCTOS</span> / {{mainCategory.name}}</span>
          {% else %}
            <span class="conceptos-title"><span class="conceptos-title-strong">PRODUCTOS</span> / TODOS</span>
          {% endif %}
          {% if mainSubcategory %}
            <span class="conceptos-title mt-1">{{mainSubcategory.name}}</span>
          {% endif %}
        </div>
        <div class="d-flex" data-toggle="modal" data-target="#filterProductsModal">
          <img class="conceptos-icon" src="{{ asset('bundles/conceptos/images/products/filter.png') }}">
        </div>
      </div>
      <div class="d-flex flex-wrap pl-lg-5 pr-lg-5">
        {% for product in products %}
          {% set priceOffer = -1 %}
          {% set offerId = 'false' %}
          {% set onlyForMembers = false %}
          {% for offer in product.offers %}
            {% if offer.startDate <= currentDate and offer.endDate >= currentDate %}
              {% set priceOffer = offer.price %}
              {% set offerId = offer.id %}
              {% if offer.onlyForMembers %}
                {% set onlyForMembers = true %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if priceOffer == -1 %}
            {% for category in product.categories %}
              {% if (category.offers[0] is defined) and ((not category.offers[0].onlyInStoreProducts) or (category.offers[0].onlyInStoreProducts and product.inStore)) %}
                {% set priceOffer = (product.price * (1 - category.offers[0].price / 100))|round(0, 'ceil') %}
              {% else %}
                {% for parentCategory in category.parents %}
                  {% if (parentCategory.offers[0] is defined) and ((not parentCategory.offers[0].onlyInStoreProducts) or (parentCategory.offers[0].onlyInStoreProducts and product.inStore)) %}
                    {% set priceOffer = (product.price * (1 - parentCategory.offers[0].price / 100))|round(0, 'ceil') %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% endif %}
          <a class="d-flex flex-column conceptos-product-card col-6 col-lg-3 p-2 p-lg-3" href="{{ path('product_details', {id: product.id, name: product.name}) }}">
            <div class="d-flex align-items-center conceptos-white-background p-2">
              <img class="conceptos-image conceptos-product-image" src="{{ vich_uploader_asset(product.mainImage, 'imageFile') }}">
            </div>
            <div class="d-flex flex-column conceptos-white-background pl-2 pr-2 pb-2 w-100">
              <span class="conceptos-product-info">{{product.name}}</span>
              <span class="conceptos-product-info-description">{{product.description}}</span>
              <div class="d-flex align-items-center">
                {% if priceOffer != -1 %}
                  <span class="conceptos-product-info conceptos-product-price mr-2">${{priceOffer}}</span>
                  <span class="conceptos-product-info conceptos-offer-price">${{product.price}}</span>
                {% else %}
                  <span class="conceptos-product-info conceptos-product-price">${{product.price}}</span>
                {% endif %}
              </div>
              <div class="d-flex justify-content-between align-items-center mt-1">
                <div class="d-flex flex-column">
                  {% if product.inStore %}
                    <span class="conceptos-in-store-product-badge">ALMACÉN</span>
                  {% endif %}
                  {% if product.recent %}
                    <span class="conceptos-new-product-badge">NUEVO</span>
                  {% endif %}
                </div>
                <button class="conceptos-add-to-cart-icon" data-path="{{ path('add_shop_card', {id: product.id}) }}">
                  <img src="{{ asset('bundles/conceptos/images/home/cart.png') }}">
                </button>
              </div>
            </div>
          </a>
        {% else %}
          <span class="conceptos-title-strong conceptos-text-align-center">NO EXISTEN PRODUCTOS CON LOS PARÁMETROS SELECCIONADOS</span>
        {% endfor %}
      </div>
    </div>

    {% if products is not empty and countProducts > 50 %}
      <input type="hidden" value="{{ app.request.query.get('page', 1) }}" id="page" name="page">
      <div class="product-paginator mt-3">
        {% set pageP = app.request.query.get('page') %}
        <div class="d-flex justify-content-center align-items-center">
          <button class="conceptos-primary-button pagination-prev mr-3" type="submit" {% if pageP == 1 %}disabled{% endif %}>
            Anterior
          </button>
          <button class="conceptos-primary-button pagination-next ml-3" type="submit" {% if products | length < 48 %}disabled{% endif %}>
            Siguiente
          </button>
        </div>
      </div>
    {% endif %}
  </form>
{% endblock %}
{% block js %}
  <script src="{{ asset('bundles/conceptos/products/js/price-range.js') }}"></script>
  <script src="{{ asset('bundles/easyadmin/javascript/select2.full.min.js') }}"></script>
  <script src="{{ asset('bundles/conceptos/libs/select2/js/i18n/es.js') }}"></script>
  <script src="{{ asset('bundles/conceptos/libs/slimscroll/jquery.slimscroll.min.js') }}"></script>
  <script src="{{ asset('bundles/conceptos/home/js/classie.js') }}"></script>
  <script src="{{ asset('bundles/conceptos/products/js/products.js') }}"></script>
{% endblock %}
